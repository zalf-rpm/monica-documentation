# General

MONICA uses a couple of configuration files to either parameterize the model or setup all input data necessary to run the model. The following four files are necessary to run the model:

 - **climate.csv**
 - **sim.json**
 - **site.json**
 - **crop.json**

The three .json files contain the necessary input information to run the MONICA model. These files contain ALL information for a model run. Optionally these files can reference other **.json** files with actual parameters of the MONICA model (crop, general soil or general environmental parameters). All necessary data can also be obtained from a SQLite database instead of the .json files. Either way (file or database), at runtime every one of the three .json files (sim/site/crop.json) will hold all information for a MONICA run. Because of that it is also possible to manually include all parameters into those three files instead of referencing other parameter files or database data. This makes especially sense if these files are being generated by an external tool for bulk processing.

All **.json** configuration files reflect to some degree the data structures internally used in MONICA. In case of missing configuration values, MONICA uses built-in default values. These can usually be taken from the corresponding **.h** (C++ header file) in the MONICA source-code. Real parameters to the MONICA model should all have default values. In contrast missing input data (like a soil profile in **site.json**) can not be compensated for and MONICA won't run.

In the following json code snippet taken from the **sim.json** example file, two settings are being declared: **UseAutomaticIrrigation** which is set to **false** and **AutoIrrigationParams** which is set to a **JSON object** (key/value map). This object/map contains three parameters: **irrigationParameters**, another JSON object, **amount**, a **JSON array** (list of values) **[17, "mm"]**, and **threshold**, a floating point (**double**) value **0.35**. As for **amount**, MONICA allows a JSON array with two or three elements in place of a simple value like **17**. The second element (in this case **"mm"**) will be treated as the unit describing the value (**17**). An optional third value can be added as a description for the value.

> **Note:** Even though the JSON array syntax can be used to add **units of measure** and an optional description, this information is  **currently ignored** by MONICA. It is meant as a mere description of the value. For the correct units of measure and dimensions, please refer  to the MONICA documentation or the example files.

```json
"UseAutomaticIrrigation": false,
"AutoIrrigationParams": {
  "irrigationParameters": {
    "nitrateConcentration": [0, "mg dm-3"],
    "sulfateConcentration": [0, "mg dm-3"]
  },
  "amount": [17, "mm"],
  "threshold": 0.35
},
```

All necessary data can be included in the configuration files either as (potentially deeply nested) JSON objects or by using a reference and include mechanism to fetch data from a SQLite database or files in the filesystem. Where applicable (e.g. **crop.json**) JSON objects can be referenced at multiple places.

## Default values
Most of the JSON object data which may be included from database or from a file support an optional **key** named **DEFAULT** that enables the user to load/include data, but overwrite some of them manually. In the example below an EnvironmentParameters JSON object is being defined. It will be initialized completely from a file, but the keys **LeachingDepth** and **WindSpeedHeight** will be overwritten. That way a user could keep rarely changing data in a file and include them always via **DEFAULT** and from project to project just change or update a few values.

```json
"EnvironmentParameters": {
  "DEFAULT": ["include-from-file", "../monica-parameters/user-parameters/hermes-environment.json"],
  "LeachingDepth": 2.0,
  "WindSpeedHeight": 2.5
}
```

## Functions

Right now there exists a single mechanism to add some dynamics to the otherwise static configuration files. In the value place of a key/value pair can appear a **JSON array** which starts with a **string/text value**. In that case upon reading and interpreting the configuration file, MONICA will check internally if there's a **function** with a name corresponding to the string value and if so interprets the whole JSON array as a function call. The first argument depicts the function being called, the rest of the array's elements depict the arguments to this function (same principle as function calls in LISP style programming languages). The result of this "function call" will be again a **JSON value** (e.g. **JSON object**) and replace the JSON array. If for some reason (e.g. wrong spelling, typo, whatever) no internal function is being found, the JSON array stays the way it is; this also being the reason for the lisp style syntax, to retain a valid **JSON document**.


### include data from a file
To include data from a file the example from above would look like the example below. The name of the function is **include-from-file** with its only parameter the path to the file to include. The whole contents of the named file should be **valid JSON** and will be included. The included JSON data may again contain other functions.

```json
"cropParams": {
  "species": ["include-from-file", "../monica-parameters/crops/rye.json"],
  "cultivar": ["include-from-file", "../monica-parameters/crops/rye/winter rye.json"]
},
"residueParams": ["include-from-file", "../monica-parameters/crop-residues/rye.json"]
```

In order to keep paths to the files to be included reasonably short and readable, relative paths will be prepended by the contents of the contents of the key **include-file-base-path**. This key is defined in **sim.json** and is allowed to exist as well in **crop.json** and **site.json**. In the latter case a "local" definition of **include-file-base-path** will replace the definition in **sim.json**. By default **include-file-base-path** in **sim.json** is defined as ```"${MONICA_PARAMETERS}/"```. This means it will be the value of the environment variable **MONICA_PARAMETERS** which after a MONICA installation will point to the directory where all the MONICA parameters where installed to (usually something like c:\\users\\USER_NAME\\MONICA\monica-parameters).

So keep in mind that if **include-from-file** has a relative path as its first parameter, **include-file-base-path** will be prepended and has to give a valid filesystem path. If **include-from-file**'s first parameter is an absolute path (eg. starting with c:\\ on Microsoft Windows or / under Linux) nothing else will be done to the path.


### reference data within a file
Crops that are defined in **crop.json** can be referenced multiple times using the **ref** function. In the example below taken from the **worksteps** section of a crop, the **Sowing** workstep among other worksteps uses the key/value pair **crop: winter rye**. The references function takes two parameters, the first being a name (**"crops"**) which is a **key** in top-level JSON object in the file that also contains another JSON object where the **key = WR** returns the JSON object to replace the function call. Thus in the example **crop.json** under the key **crops**, arbitrary crop name shortcuts are mapped to crop parameter objects. The objects themselves can be included by using the **include-from-db** or **include-from-file** functions.

```json
{ "date": "1991-09-23", "type": "Sowing", "crop": ["ref", "crops", "WR"] },
```

### other functions

function name | parameter 1 (example) | parameter 2 (example) | description
------------- | --------------------- | --------------------- | -----------
"humus-class->corg" | humus class (**1**) | - | converts the humus class to corg value
"bulk-density-class->raw-density" | effective bulk density class (**1 - 5**) | clay content (**0.0 - 1.0**) | converts the effective bulk density given the clay content to raw density |
"KA5-texture-class->clay" | KA5 texture class (**fSms**) | - | returns the average clay content given the KA5 texture class
"KA5-texture-class->sand" |  KA5 texture class (**Lt3**) | - | returns the average sand content given the KA5 texture class
"sand-and-clay->lambda" | sand content (**0.0 - 1.0**) | clay content (**0.0 - 1.0**) | calculates the lambda value given sand and clay content

As shown in the following examples taken from **site.json**, the function calls can be nested.

```json
"SoilRawDensity": ["bulk-density-class->raw-densit", 2, ["KA5-texture-class->cla", "Sl2"]],
"Lambda": ["sand-and-clay->lambda", ["KA5-texture-class->sand", "Sl2"], ["KA5-texture-class->cla", "Sl2"]]
```


# JSON data format
Currently MONICA uses  [**JSON**](http://www.json.org) as format for its files. Please ensure that you adhere to the rules and formatting conventions of JSON! In order to check and/or reformat existing code, tools like [this online json viewer](http://codebeautify.org/jsonviewer) or [this one](https://jsonformatter.curiousconcept.com) can be used.

**JSON** has no syntax for comments, it's a pure data format. In order to make the configuration files more self describing, but keep them valid **JSON** files, comments are encoded as keys beginning with two underscores **__** and an empty string **""** as its value. Instead of comments this can also be used to comment out structures which should currently not be used, simply by making a key invalid, e.g. by adding an underscore character in front **_** or rename it to a name unknown to MONICA.
